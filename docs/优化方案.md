• Market Filtering Optimization Doc

  - 目标：让 Polymarket 波段/套利筛选更稳健，兼容不同市场结构，并与官方数据/实时流实践
    保持一致。
  - 上下文：当前 MarketScreener 固定权重 + 顺序假设，SwingTradingStrategy 每个市场重复
    请求外部数据，WebSocket 全量订阅缺少过滤；Telegram 去重/统计数据尚未反哺筛选。

  ———

  1. 数据与结构

  - Outcome 标准化 (src/models/market.py): 建立 YES/NO 索引（或在 Market 中新增
    get_yes_outcome() 等方法），所有筛选逻辑只通过这些 helper 访问价格，避免
    outcomes[0] 顺序依赖。
  - REST + WebSocket 融合: REST 拉取基础指标，WebSocket 仅订阅筛选后的 Top-N 市场（利用
    官方 skill 建议的 clob_market.price_change / activity.trades topic filters），实时
    回填短期波动、成交量和 spread。
  - 公共上下文缓存: 在一次扫描中预先获取 BTC 价、宏观新闻、全局情绪等信息放入共享对象，
    传递给 screener 与策略，减少对 Binance/CryptoCompare 的重复请求。

  ———

  2. 过滤逻辑增强

  - 基础条件：
      1. liquidityNum ≥ 10k、volume24hr ≥ 1k（可配置）。
      2. spread ≤ 10%, YES ∈ [0.2,0.8]，且明确支持二元市场。
      3. 可选：openInterest、liquidityDepth10、recentTrades，若 API 返回则纳入。
  - 评分改进：
      - 动态权重：把 OpportunityTracker 的历史收益率/命中率作为反馈，周期性（每日/每
        周）调整 WEIGHTS 与 MIN_TOTAL_SCORE。
      - 外部驱动匹配：将 BTC 波动、新闻情绪、事件类别偏好纳入 timing_score，例如加分
        项：BTC 波动 > X%、近期相关新闻命中关键词等。
      - 冷却机制：结合 Telegram _notified_markets，把 6 小时内已推送的市场直接打低分或
        排除，避免重复扫描同一市场。
  - 可扩展特征：
      - 引入 momentum_score（近 1h/4h/24h 价格斜率）、depth_score（订单簿顶部深度），并
        允许通过配置文件开关。
      - 对体育/娱乐等非数据驱动类别设置白名单/黑名单，可通过 .env 或单独 YAML 指定。

  ———

  3. 实盘可靠性

  - 速率限制：缓存 Binance/CryptoCompare 响应 5 分钟以内复用；在筛选阶段仅在首次迭代或
    缓存过期时刷新。
  - I/O 与并发：OpportunityTracker/通知缓存改为批量写（例如每 5 分钟或 N 条后 flush），
    避免实时模式频繁写磁盘。
  - 错单处理：执行端若 YES 成功 NO 失败，应立即触发回滚或对冲，并调用
    RiskManager.remove_exposure()；筛选逻辑需参考实际成交成功率（可由 PositionTracker
    统计提供）。

  ———

  4. 策略协同

  - 参数面板：输出 MarketScreener 的特征/分数及 OpportunityTracker 历史表现，形成仪表盘
    （可由 stats_cli.py 扩展 JSON）供调节 confidence_threshold、止盈/止损。
  - 实时数据驱动：订阅 clob_market 聚合订单簿/最近成交，计算 micro-spread、impact
    cost，作为波段策略的风险/仓位调节因子。
  - 信号生命周期：在 Swing 模式中加入持仓检查 + 自动出场（达成止盈/止损或模型反向信
    号），并把结果反馈给筛选器（例如某市场近期信号过多但收益低，则下调评分）。

  ———

  5. 执行步骤

  1. 重构 Screener：实现 outcome helper、可插拔特征、动态阈值/权重配置（JSON/YAML）。
  2. 缓存层：在 Engine 中添加 BTC/新闻全局缓存，扫描循环内传引用；对 REST/WebSocket 使
     用 skill 推荐的过滤式订阅。
  3. 反馈闭环：扩展 OpportunityTracker 与 stats_cli，输出筛选特征与实际结果的关联，定期
     自动调参。
  4. 文档与测试：记录新的筛选参数与实时订阅策略；为 Screener 与缓存逻辑添加单测 & 回测
     脚本；跑 pytest 验证基础策略/风控仍通过。

  ———

  推荐工具

  - 结合官方 @polymarket/real-time-data-client 订阅需要的 topic，或在现有 Python
    WebSocket 客户端中仿照其过滤方式。
  - 使用任务调度（如 APScheduler）定期回顾 OpportunityTracker 数据，自动生成“筛选配置建
    议”。
  - 若需更复杂的动态权重，可考虑训练简单的线性模型或强化学习 agent，把 Market 特征映射
    到“预期收益”后排序。

  这样可在保持代码结构清晰的同时，提高筛选准确性、减少 API 压力，并与策略/执行/通知形成
  闭环。